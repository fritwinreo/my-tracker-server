<!DOCTYPE html>
<html>
<head>
    <title>Team Tracker</title>
    <style>
        #map { height: 100vh; width: 100%; }
        body, html { margin: 0; padding: 0; }
        #controls { position: absolute; top: 10px; left: 10px; z-index: 5; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,.3); }
    </style>
    <script src="https://fritwin-tracker-server.onrender.com/socket.io/socket.io.js"></script>
    <script>
        const socket = io('https://fritwin-tracker-server.onrender.com', {
            transports: ['websocket']
        });

        let map;
        let markers = {};
        let infoWindows = {};
        let accuracyCircles = {};

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 0, lng: 0 },
                zoom: 2,
            });

            const controlsDiv = document.createElement('div');
            controlsDiv.id = 'controls';
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlsDiv);

            const centerButton = document.createElement('button');
            centerButton.innerText = "Zoom to User 1";
            centerButton.onclick = function() {
                const user1Location = markers[Object.keys(markers)[0]];
                if (user1Location) {
                    map.setZoom(15);
                    map.setCenter(user1Location.getPosition());
                }
            };
            controlsDiv.appendChild(centerButton);

            socket.on('locationUpdate', (userLocations) => {
                const users = Object.values(userLocations);
                users.forEach(location => {
                    const id = location.id;
                    const latLng = { lat: location.latitude, lng: location.longitude };

                    if (markers[id]) {
                        markers[id].setPosition(latLng);
                        accuracyCircles[id].setCenter(latLng);
                    } else {
                        markers[id] = new google.maps.Marker({
                            position: latLng,
                            map: map,
                            title: location.name,
                            label: location.name,
                        });

                        infoWindows[id] = new google.maps.InfoWindow({
                            content: `<h3>${location.name}</h3>`
                        });

                        accuracyCircles[id] = new google.maps.Circle({
                            strokeColor: '#007BFF',
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: '#007BFF',
                            fillOpacity: 0.35,
                            map: map,
                            center: latLng,
                            radius: 100
                        });

                        markers[id].addListener("click", () => {
                            infoWindows[id].open(map, markers[id]);
                        });
                    }
                });
            });
        }

        // âœ… Keep-alive ping every 5 minutes
        setInterval(() => {
            fetch('https://fritwin-tracker-server.onrender.com/ping')
                .then(res => console.log("Keep-alive ping:", res.status))
                .catch(err => console.error("Ping failed:", err));
        }, 300000); // 5 minutes
    </script>
</head>
<body>
    <div id="map"></div>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBX4kAFkXUnHpytxzOsjNzxIJEj3sK4yNo&callback=initMap"></script>
</body>
</html>
